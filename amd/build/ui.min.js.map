{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// UI logic for tiny_eunitylink plugin\nimport {get_string as getString} from 'core/str';\nimport {component} from './common';\n\n/**\n * Show the eUnity link dialog, collect data, call backend, and insert link.\n * @param {TinyMCE} editor\n */\nexport async function handleAction(editor) {\n    // Get localized strings.\n    const [title, linktextLabel, accessionLabel, createLabel] = await Promise.all([\n        getString('dialogtitle', component),\n        getString('linktext', component),\n        getString('accessionnumber', component),\n        getString('createlink', component),\n    ]);\n\n    // Get current selection for default link text.\n    const selectedText = editor.selection ? editor.selection.getContent({format: 'text'}) : '';\n\n    // Create dialog HTML.\n    const dialogHtml = `\n        <form id=\"eunitylink-form\" class=\"tiny-eunitylink-form\">\n            <div class=\"form-group\">\n                <label>${linktextLabel}</label>\n                <input type=\"text\" name=\"linktext\" class=\"form-control\" value=\"${selectedText}\" required />\n            </div>\n            <div class=\"form-group\">\n                <label>${accessionLabel}</label>\n                <input type=\"text\" name=\"accessionnumber\" class=\"form-control\" required />\n            </div>\n        </form>\n    `;\n\n    // Show TinyMCE dialog.\n    editor.windowManager.open({\n        title,\n        body: {\n            type: 'panel',\n            items: [\n                {type: 'htmlpanel', html: dialogHtml}\n            ]\n        },\n        buttons: [\n            {\n                type: 'cancel',\n                text: 'Cancel'\n            },\n            {\n                type: 'submit',\n                text: createLabel,\n                primary: true\n            }\n        ],\n        initialData: {},\n        onSubmit: async (api) => {\n            // Get form values from DOM.\n            const form = document.querySelector('#eunitylink-form');\n            const linktext = form.linktext.value.trim();\n            const accessionnumber = form.accessionnumber.value.trim();\n            if (!linktext || !accessionnumber) {\n                // Optionally show error\n                return;\n            }\n            // Call backend to get/proxy the link.\n            try {\n                const response = await fetch(M.cfg.wwwroot + '/local/linkproxy/rest.php', {\n                    method: 'POST',\n                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},\n                    body: new URLSearchParams({\n                        action: 'get_dbvals',\n                        accessionnumber,\n                        contextid: M.cfg.contextid\n                    })\n                });\n                const data = await response.json();\n                if (data && data.result && data.result.url) {\n                    // Insert the link into the editor.\n                    editor.insertContent(`<a href=\"${data.result.url}\" target=\"_blank\">${linktext}</a>`);\n                    api.close();\n                } else {\n                    window.alert('Failed to create link.');\n                }\n            } catch (e) {\n                window.alert('Error contacting backend.');\n            }\n        }\n    });\n}"],"names":["editor","title","linktextLabel","accessionLabel","createLabel","Promise","all","component","selectedText","selection","getContent","format","dialogHtml","windowManager","open","body","type","items","html","buttons","text","primary","initialData","onSubmit","async","form","document","querySelector","linktext","value","trim","accessionnumber","response","fetch","M","cfg","wwwroot","method","headers","URLSearchParams","action","contextid","data","json","result","url","insertContent","api","close","window","alert","e"],"mappings":"4LAQmCA,cAExBC,MAAOC,cAAeC,eAAgBC,mBAAqBC,QAAQC,IAAI,EAC1E,mBAAU,cAAeC,oBACzB,mBAAU,WAAYA,oBACtB,mBAAU,kBAAmBA,oBAC7B,mBAAU,aAAcA,qBAItBC,aAAeR,OAAOS,UAAYT,OAAOS,UAAUC,WAAW,CAACC,OAAQ,SAAW,GAGlFC,sJAGeV,kHACwDM,wHAGxDL,kKAOrBH,OAAOa,cAAcC,KAAK,CACtBb,MAAAA,MACAc,KAAM,CACFC,KAAM,QACNC,MAAO,CACH,CAACD,KAAM,YAAaE,KAAMN,cAGlCO,QAAS,CACL,CACIH,KAAM,SACNI,KAAM,UAEV,CACIJ,KAAM,SACNI,KAAMhB,YACNiB,SAAS,IAGjBC,YAAa,GACbC,SAAUC,MAAAA,YAEAC,KAAOC,SAASC,cAAc,oBAC9BC,SAAWH,KAAKG,SAASC,MAAMC,OAC/BC,gBAAkBN,KAAKM,gBAAgBF,MAAMC,UAC9CF,UAAaG,0BAMRC,eAAiBC,MAAMC,EAAEC,IAAIC,QAAU,4BAA6B,CACtEC,OAAQ,OACRC,QAAS,gBAAiB,qCAC1BvB,KAAM,IAAIwB,gBAAgB,CACtBC,OAAQ,aACRT,gBAAAA,gBACAU,UAAWP,EAAEC,IAAIM,cAGnBC,WAAaV,SAASW,OACxBD,MAAQA,KAAKE,QAAUF,KAAKE,OAAOC,KAEnC7C,OAAO8C,iCAA0BJ,KAAKE,OAAOC,iCAAwBjB,kBACrEmB,IAAIC,SAEJC,OAAOC,MAAM,0BAEnB,MAAOC,GACLF,OAAOC,MAAM"}